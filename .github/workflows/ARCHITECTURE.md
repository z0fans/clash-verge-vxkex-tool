# VxKex 自动化构建系统架构

## 🏗️ 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                      GitHub Repository                          │
│                                                                 │
│  ┌───────────┐   ┌──────────────┐   ┌────────────────────┐   │
│  │  源代码    │   │  .github/    │   │  构建配置文件      │   │
│  │  *.c,*.h   │   │  workflows/  │   │  *.sln, *.vcxproj │   │
│  └─────┬─────┘   └──────┬───────┘   └─────────┬──────────┘   │
│        │                │                      │               │
└────────┼────────────────┼──────────────────────┼───────────────┘
         │                │                      │
         │                │                      │
    推送标签 v1.1.4.0     │                      │
         │                │                      │
         ▼                ▼                      ▼
┌─────────────────────────────────────────────────────────────────┐
│              GitHub Actions (Windows Server 2019)                │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  步骤 1-3: 环境准备                                    │    │
│  │  • Checkout 代码                                       │    │
│  │  • 设置 MSBuild (Visual Studio 2019)                   │    │
│  │  • 恢复 NuGet 包                                       │    │
│  └────────────────┬───────────────────────────────────────┘    │
│                   ▼                                             │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  步骤 4-5: 编译                                        │    │
│  │  ┌──────────────┐         ┌──────────────┐            │    │
│  │  │  x86 构建    │         │  x64 构建    │            │    │
│  │  │  (Win32)     │         │  (x64)       │            │    │
│  │  │              │         │              │            │    │
│  │  │  .\Release\  │         │ .\x64\Release│            │    │
│  │  └──────┬───────┘         └──────┬───────┘            │    │
│  └─────────┼────────────────────────┼────────────────────┘    │
│            │                        │                          │
│            └────────┬───────────────┘                          │
│                     ▼                                           │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  步骤 6: 收集构建产物                                  │    │
│  │                                                        │    │
│  │  PackageRoot/                                          │    │
│  │  ├── x86/                                              │    │
│  │  │   ├── KexDll.dll                                    │    │
│  │  │   ├── VxKexLdr.exe                                  │    │
│  │  │   ├── KexCfg.exe                                    │    │
│  │  │   └── ...                                           │    │
│  │  ├── x64/                                              │    │
│  │  │   ├── KexDll.dll                                    │    │
│  │  │   ├── VxKexLdr.exe                                  │    │
│  │  │   └── ...                                           │    │
│  │  └── Documentation/                                    │    │
│  └────────────────┬───────────────────────────────────────┘    │
│                   ▼                                             │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  步骤 7-9: 创建安装程序                                │    │
│  │                                                        │    │
│  │  ┌─────────────────┐                                  │    │
│  │  │ 安装 Inno Setup │                                  │    │
│  │  └────────┬────────┘                                  │    │
│  │           ▼                                            │    │
│  │  ┌──────────────────────────────────────┐             │    │
│  │  │ 动态生成 ISS 脚本                     │             │    │
│  │  │                                      │             │    │
│  │  │ [Setup] 基础配置                     │             │    │
│  │  │ [Files] 文件列表                     │             │    │
│  │  │ [Code]  Pascal Script:               │             │    │
│  │  │   • FindClashVergeInstallPath()      │             │    │
│  │  │   • ConfigureVxKexForExe()           │             │    │
│  │  │   • AutoConfigureClashVerge()        │             │    │
│  │  └────────┬─────────────────────────────┘             │    │
│  │           ▼                                            │    │
│  │  ┌────────────────┐                                   │    │
│  │  │ ISCC.exe 编译  │                                   │    │
│  │  └────────┬───────┘                                   │    │
│  │           ▼                                            │    │
│  │  VxKex-{版本}-Setup.exe ✓                             │    │
│  └────────────────┬───────────────────────────────────────┘    │
│                   ▼                                             │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  步骤 10: 创建便携版                                   │    │
│  │                                                        │    │
│  │  Compress-Archive                                      │    │
│  │  ├── VxKex-{版本}-Portable-x86.zip ✓                  │    │
│  │  └── VxKex-{版本}-Portable-x64.zip ✓                  │    │
│  └────────────────┬───────────────────────────────────────┘    │
│                   ▼                                             │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  步骤 11: 生成校验和                                   │    │
│  │                                                        │    │
│  │  Get-FileHash (SHA256)                                 │    │
│  │  ├── *.exe.sha256                                      │    │
│  │  └── *.zip.sha256                                      │    │
│  └────────────────┬───────────────────────────────────────┘    │
│                   ▼                                             │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  步骤 12-13: 发布                                      │    │
│  │                                                        │    │
│  │  • 上传到 Artifacts (所有触发方式)                    │    │
│  │  • 创建 GitHub Release (仅标签触发)                   │    │
│  │  • 自动生成 Release Notes                             │    │
│  └────────────────┬───────────────────────────────────────┘    │
└───────────────────┼──────────────────────────────────────────┘
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                    GitHub Releases 页面                         │
│                                                                 │
│  📦 VxKex v1.1.4.0                                              │
│                                                                 │
│  Assets:                                                        │
│  • VxKex-1.1.4.0-Setup.exe              (8.5 MB) ⬇️            │
│  • VxKex-1.1.4.0-Portable-x86.zip       (4.2 MB) ⬇️            │
│  • VxKex-1.1.4.0-Portable-x64.zip       (5.1 MB) ⬇️            │
│  • VxKex-1.1.4.0-Setup.exe.sha256       (100 B)  ⬇️            │
│  • VxKex-1.1.4.0-Portable-x86.zip.sha256 (100 B) ⬇️            │
│  • VxKex-1.1.4.0-Portable-x64.zip.sha256 (100 B) ⬇️            │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔄 Clash Verge 自动配置流程

```
┌─────────────────────────────────────────────────────────────────┐
│             VxKex 安装程序运行时 (ssPostInstall)                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  FindClashVergeInstallPath()                                    │
│  按优先级检测:                                                  │
│  1. HKLM64 Uninstall 注册表                                     │
│  2. HKLM32 Uninstall 注册表                                     │
│  3. HKCU Uninstall 注册表                                       │
│  4. %LOCALAPPDATA%\Programs\Clash Verge                         │
│  5. C:\Program Files\Clash Verge                                │
│  6. C:\Program Files (x86)\Clash Verge                          │
└────────────────┬────────────────────────────────────────────────┘
                 │
      找到路径? ┌┴┐ 未找到
                │         │
            是 │         └──> 跳过配置,写入日志
                ▼
┌─────────────────────────────────────────────────────────────────┐
│  AutoConfigureClashVerge()                                      │
│  准备配置 4 个文件:                                             │
│  • Clash Verge.exe                                              │
│  • resources\clash-verge-service.exe                            │
│  • resources\install-service.exe                                │
│  • resources\uninstall-service.exe                              │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
       ┌─────────────────┐
       │  循环处理每个文件 │
       └────────┬─────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────────┐
│  ConfigureVxKexForExe(ExeFullPath, DisableForChild=True)        │
│                                                                 │
│  1. 验证文件存在                                                │
│  2. 提取基础文件名 (例如: "Clash Verge.exe")                   │
│  3. 生成随机子键名 (例如: "VxKex_A1B2C3D4E5F6G7H8")           │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  写入注册表配置                                                 │
│  基础路径: HKLM64\SOFTWARE\Microsoft\Windows NT\               │
│            CurrentVersion\Image File Execution Options\         │
│                                                                 │
│  步骤:                                                          │
│  1. 在 "Clash Verge.exe" 键下写入:                             │
│     UseFilter = 1  (REG_DWORD)                                  │
│                                                                 │
│  2. 在 "Clash Verge.exe\VxKex_XXXXXXXX" 子键下写入:            │
│     ┌─────────────────────────────────────────┐                │
│     │ FilterFullPath = "D:\...\Clash Verge.exe"                │
│     │   (REG_SZ - 完整路径,用于精确匹配)       │                │
│     ├─────────────────────────────────────────┤                │
│     │ VerifierDlls = "kexdll.dll"             │                │
│     │   (REG_SZ - 要注入的 DLL)                │                │
│     ├─────────────────────────────────────────┤                │
│     │ GlobalFlag = 0x100                      │                │
│     │   (REG_DWORD - 启用 App Verifier)        │                │
│     ├─────────────────────────────────────────┤                │
│     │ VerifierFlags = 0x80000000              │                │
│     │   (REG_DWORD - 禁用慢速 page heap)       │                │
│     ├─────────────────────────────────────────┤                │
│     │ KEX_DisableForChild = 1                 │                │
│     │   (REG_DWORD - 禁用子进程继承) ⭐        │                │
│     ├─────────────────────────────────────────┤                │
│     │ KEX_DisableAppSpecific = 0              │                │
│     │   (REG_DWORD - 启用应用特定 hack)        │                │
│     ├─────────────────────────────────────────┤                │
│     │ KEX_WinVerSpoof = 0                     │                │
│     │   (REG_DWORD - 无版本伪装)               │                │
│     ├─────────────────────────────────────────┤                │
│     │ KEX_StrongVersionSpoof = 0              │                │
│     │   (REG_DWORD - 无强版本伪装)             │                │
│     └─────────────────────────────────────────┘                │
└────────────────┬────────────────────────────────────────────────┘
                 │
    配置成功? ┌┴┐ 失败
                │         │
            是 │         └──> 写入错误日志
                ▼
┌─────────────────────────────────────────────────────────────────┐
│  成功计数器 +1                                                  │
│  写入成功日志                                                   │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
       ┌─────────────────┐
       │ 还有下一个文件?  │
       └────────┬─────────┘
                │
          是 ┌──┴──┐ 否
             │     │
      回到循环      ▼

┌─────────────────────────────────────────────────────────────────┐
│  输出最终统计                                                   │
│  "Clash Verge auto-configuration completed: X/4"                │
│                                                                 │
│  安装程序继续完成后续步骤                                       │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔐 IFEO 注入机制原理

```
┌─────────────────────────────────────────────────────────────────┐
│  用户启动 Clash Verge.exe                                       │
└────────────────┬────────────────────────────────────────────────┘
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  Windows 进程创建 (kernel32!CreateProcessInternalW)            │
│  检查 IFEO 注册表配置                                           │
└────────────────┬────────────────────────────────────────────────┘
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  ntdll!LdrpInitializeProcess                                    │
│  1. 发现 VerifierDlls = "kexdll.dll"                            │
│  2. 发现 GlobalFlag 包含 FLG_APPLICATION_VERIFIER               │
│  3. 触发 Application Verifier 机制                             │
└────────────────┬────────────────────────────────────────────────┘
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  Application Verifier 加载 kexdll.dll                           │
│  调用 KexDll!DllMain (DLL_PROCESS_VERIFIER)                     │
│                                                                 │
│  ⚠️  此时进程尚未初始化:                                        │
│     • kernel32.dll 未加载                                       │
│     • 主程序入口点未执行                                        │
│     • 只能使用 ntdll.dll 的函数                                 │
└────────────────┬────────────────────────────────────────────────┘
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  KexDll 执行核心逻辑:                                           │
│  1. 读取 KEX_* 配置值                                           │
│  2. 扫描主 EXE 的导入表                                         │
│  3. 识别需要扩展的 Windows API                                  │
│  4. 修改导入表,重定向到 Kx*.dll:                               │
│     ┌────────────────────────────────────────┐                 │
│     │ 原始导入:                               │                 │
│     │   kernel32.dll!CreateFile2             │                 │
│     │          ↓ 修改为                       │                 │
│     │   KxBase.dll!CreateFile2               │                 │
│     └────────────────────────────────────────┘                 │
│  5. 根据 KEX_DisableForChild 设置传播标志                       │
└────────────────┬────────────────────────────────────────────────┘
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  Windows 继续进程初始化                                         │
│  1. 加载 kernel32.dll (实际加载 KxBase.dll 中的扩展)           │
│  2. 加载其他 DLL                                                │
│  3. 执行主程序入口点                                            │
└────────────────┬────────────────────────────────────────────────┘
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  Clash Verge 正常运行                                           │
│  • 调用 Windows 8/10 API 时实际调用 VxKex 实现                 │
│  • 对应用完全透明                                               │
│  • 子进程不继承 VxKex (因为 DisableForChild=1)                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📦 构建产物结构

### Setup.exe 内部结构

```
VxKex-1.1.4.0-Setup.exe (Inno Setup 封装)
│
├── [安装程序代码]
│   ├── 安装向导 UI
│   ├── 文件提取逻辑
│   ├── 注册表操作
│   └── Pascal Script 引擎
│
├── [压缩数据]
│   ├── x64/ (如果是 64位系统)
│   │   ├── KexDll.dll        - 核心注入 DLL
│   │   ├── VxKexLdr.exe      - 加载器
│   │   ├── KexCfg.exe        - 配置工具
│   │   ├── KexGui.dll        - GUI 库
│   │   ├── KexShlEx.dll      - Shell 扩展
│   │   ├── KxBase.dll        - kernel32 扩展
│   │   ├── KxUser.dll        - user32 扩展
│   │   ├── KxAdvapi.dll      - advapi32 扩展
│   │   ├── KxCom.dll         - COM 扩展
│   │   ├── KxCrt.dll         - C 运行时扩展
│   │   ├── KxCryp.dll        - 加密 API 扩展
│   │   ├── KxDx.dll          - DirectX 扩展
│   │   ├── KxMi.dll          - MI 扩展
│   │   ├── KxNet.dll         - 网络 API 扩展
│   │   └── KxNt.dll          - ntdll 扩展
│   │
│   ├── x86/ (如果是 32位系统)
│   │   └── [相同的文件列表]
│   │
│   └── Documentation/
│       ├── Application Compatibility List.docx
│       ├── Changelog.txt
│       └── VxKex Registry Keys.docx
│
└── [嵌入的 Pascal Script]
    ├── FindClashVergeInstallPath()
    ├── ConfigureVxKexForExe()
    └── AutoConfigureClashVerge()
```

### Portable.zip 结构

```
VxKex-1.1.4.0-Portable-x64.zip
│
├── KexDll.dll
├── VxKexLdr.exe
├── KexCfg.exe
├── KexGui.dll
├── KexShlEx.dll
├── Kx*.dll (所有扩展 DLL)
└── README.txt
```

---

## ⚡ 性能指标

| 阶段 | 耗时 | 说明 |
|------|------|------|
| 代码检出 | 10-30秒 | 取决于仓库大小 |
| MSBuild 设置 | 5-10秒 | 缓存后更快 |
| x86 编译 | 3-5分钟 | 175个源文件 |
| x64 编译 | 3-5分钟 | 175个源文件 |
| 产物收集 | 10-20秒 | 文件复制操作 |
| Inno Setup 安装 | 30-60秒 | 首次下载慢 |
| 安装程序编译 | 1-2分钟 | 取决于压缩设置 |
| 便携版打包 | 20-40秒 | ZIP 压缩 |
| 校验和生成 | 5-10秒 | SHA256 计算 |
| 上传产物 | 30-90秒 | 取决于网络 |
| **总计** | **10-15分钟** | **端到端时间** |

---

## 🛡️ 安全考虑

### 代码签名流程 (可选)

```
┌─────────────────────────────────────────────────────────────────┐
│  开发者本地                                                     │
│  1. 从 CA 机构购买代码签名证书                                  │
│  2. 导出为 PFX 格式                                             │
│  3. 转换为 Base64                                               │
└────────────────┬────────────────────────────────────────────────┘
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  GitHub Repository Secrets                                      │
│  • CERTIFICATE_BASE64 (加密存储)                                │
│  • CERTIFICATE_PASSWORD (加密存储)                              │
└────────────────┬────────────────────────────────────────────────┘
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  GitHub Actions 运行时                                          │
│  1. 解码 Base64 证书                                            │
│  2. 写入临时文件                                                │
│  3. 使用 signtool.exe 签名                                      │
│  4. 添加时间戳 (http://timestamp.digicert.com)                 │
│  5. 删除临时证书文件                                            │
└────────────────┬────────────────────────────────────────────────┘
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  已签名的安装程序                                               │
│  • 数字签名有效                                                 │
│  • 包含时间戳 (证书过期后仍可验证)                             │
│  • 减少 SmartScreen 警告                                        │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔍 调试与监控

### GitHub Actions 日志层级

```
Workflow: Build and Release VxKex
│
├── Job: build
│   │
│   ├── Step: Checkout Repository
│   │   └── [Git clone 日志]
│   │
│   ├── Step: Setup MSBuild
│   │   └── [MSBuild 版本信息]
│   │
│   ├── Step: Build x86
│   │   ├── [MSBuild 详细输出]
│   │   ├── [编译警告/错误]
│   │   └── [链接信息]
│   │
│   ├── Step: Build x64
│   │   └── [同上]
│   │
│   ├── Step: Collect Build Artifacts
│   │   └── [文件复制日志]
│   │
│   ├── Step: Create Inno Setup Script
│   │   └── [脚本生成日志]
│   │
│   ├── Step: Compile Installer
│   │   ├── [ISCC.exe 输出]
│   │   ├── [Clash Verge 检测日志] ⭐
│   │   └── [配置成功/失败信息] ⭐
│   │
│   └── Step: Create GitHub Release
│       └── [Release API 响应]
│
└── Artifacts
    ├── VxKex-Installers (30 days)
    └── [所有构建产物]
```

---

## 📈 扩展性

### 支持更多应用

只需添加新的自动配置函数:

```pascal
procedure AutoConfigureApp1;
begin
  // 检测和配置逻辑
end;

procedure AutoConfigureApp2;
begin
  // 检测和配置逻辑
end;

procedure CurStepChanged(CurStep: TSetupStep);
begin
  if CurStep = ssPostInstall then
  begin
    AutoConfigureClashVerge;
    AutoConfigureApp1;
    AutoConfigureApp2;
    // ... 添加更多
  end;
end;
```

### 支持更多平台

```yaml
strategy:
  matrix:
    platform: [Win32, x64, ARM64]

steps:
  - name: Build ${{ matrix.platform }}
    run: msbuild VxKex.sln /p:Platform=${{ matrix.platform }}
```

---

**这就是完整的 VxKex 自动化构建系统架构!** 🎉
