name: Build PowerShell Executable

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create Self-Extracting EXE with IExpress
      shell: cmd
      run: |
        echo åˆ›å»ºè‡ªè§£å‹ EXE...

        REM åˆ›å»ºè¾“å‡ºç›®å½•
        if not exist dist mkdir dist

        REM ä½¿ç”¨ IExpress åˆ›å»ºè‡ªè§£å‹ EXE
        iexpress /N /Q create-sfx.sed

        echo âœ“ è‡ªè§£å‹ EXE åˆ›å»ºå®Œæˆ

    - name: Check build output
      shell: pwsh
      run: |
        Write-Host "`næ„å»ºè¾“å‡º:" -ForegroundColor Cyan
        if (Test-Path "dist\ClashVerge-VxKex-Configurator.exe") {
          $size = [math]::Round((Get-Item "dist\ClashVerge-VxKex-Configurator.exe").Length / 1MB, 2)
          Write-Host "  ClashVerge-VxKex-Configurator.exe ($size MB)" -ForegroundColor Green
          Write-Host "  âœ“ è‡ªè§£å‹ EXE æ„å»ºæˆåŠŸ!" -ForegroundColor Green
        } else {
          Write-Host "  âŒ æœªæ‰¾åˆ°è¾“å‡ºæ–‡ä»¶" -ForegroundColor Red
          exit 1
        }

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ClashVerge-VxKex-Configurator
        path: dist\ClashVerge-VxKex-Configurator.exe

    - name: Create Release (on tag push)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: dist\ClashVerge-VxKex-Configurator.exe
        body: |
          ## Clash Verge VxKex ä¸€é”®é…ç½®å·¥å…· (PowerShell åŸç”Ÿç‰ˆ)

          ### âœ¨ æ–°ç‰ˆæœ¬ç‰¹æ€§
          - ğŸ **å•æ–‡ä»¶ EXE** - ä¸€ä¸ªæ–‡ä»¶åŒ…å«æ‰€æœ‰å†…å®¹
          - ğŸš€ **ä¸‹è½½å³ç”¨** - æ— éœ€è§£å‹,ç›´æ¥è¿è¡Œ
          - ğŸ“¦ **è‡ªåŠ¨è§£å‹** - ä½¿ç”¨ Windows å†…ç½®çš„ IExpress æŠ€æœ¯
          - âš¡ **é›¶ä¾èµ–** - PowerShell åŸç”Ÿ,æ— éœ€ Python æˆ– .NET Framework 4.0+
          - ğŸ’¯ **å®Œç¾å…¼å®¹** - Windows 7 SP1+ åŸç”Ÿæ”¯æŒ

          ### ğŸ“¥ ä½¿ç”¨æ–¹æ³•ï¼ˆè¶…çº§ç®€å•ï¼ï¼‰
          1. ä¸‹è½½ `ClashVerge-VxKex-Configurator.exe`
          2. å³é”® â†’ **ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ**
          3. ç‚¹å‡»"æ˜¯"ç¡®è®¤
          4. è‡ªåŠ¨è§£å‹å¹¶å¯åŠ¨ GUI ç•Œé¢
          5. é€‰æ‹© Clash Verge è·¯å¾„ï¼ˆæˆ–è‡ªåŠ¨æ£€æµ‹ï¼‰
          6. ç‚¹å‡»"ğŸš€ ä¸€é”®å¯ç”¨ VxKex"æŒ‰é’®
          7. âœ… å®Œæˆï¼ç°åœ¨å¯ä»¥å¯åŠ¨ Clash Verge äº†

          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - Windows 7 SP1 æˆ–æ›´é«˜ç‰ˆæœ¬
          - PowerShell 2.0+ (Windows 7+ å†…ç½®)
          - **æ— éœ€ä»»ä½•é¢å¤–è½¯ä»¶**
          - éœ€è¦ç®¡ç†å‘˜æƒé™

          ### ğŸ¯ æŠ€æœ¯è¯´æ˜
          - ä½¿ç”¨ IExpress (Windows å†…ç½®) åˆ›å»ºè‡ªè§£å‹ EXE
          - åŒ…å« PowerShell è„šæœ¬å’Œ VxKex å®‰è£…åŒ…
          - ä¸´æ—¶è§£å‹åˆ° %TEMP% ç›®å½•
          - é…ç½®å®Œæˆåè‡ªåŠ¨æ¸…ç†

          ### ğŸ”— ç›¸å…³é“¾æ¥
          - [é—®é¢˜è®¨è®º (Issue #1041)](https://github.com/clash-verge-rev/clash-verge-rev/issues/1041)
          - [VxKex é¡¹ç›®](https://github.com/i486/VxKex)
          - [Clash Verge Rev](https://github.com/clash-verge-rev/clash-verge-rev)

          ### ğŸ’¡ æŠ€æœ¯æ ˆ
          - PowerShell + Windows Forms
          - ps2exe æ‰“åŒ…å·¥å…·
          - 100% åŸç”Ÿ Windows æŠ€æœ¯
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
