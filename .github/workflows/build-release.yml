name: Build and Release VxKex

on:
  push:
    tags:
      - 'v*.*.*'  # 当推送 v1.0.0 格式的标签时触发
  workflow_dispatch:  # 允许手动触发
    inputs:
      version:
        description: 'Version number (e.g., 1.1.3.1428)'
        required: true
        default: '1.1.3.1428'

env:
  SOLUTION_NAME: VxKex/VxKex.sln
  BUILD_CONFIGURATION: Release

jobs:
  build:
    name: Build VxKex Installer
    runs-on: windows-2019  # 使用 Windows Server 2019 (包含 VS2019)

    steps:
    # ========== 步骤 1: 检出代码 ==========
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整历史用于版本号生成

    # ========== 步骤 2: 设置 MSBuild 环境 ==========
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      with:
        vs-version: '[16.0,17.0)'  # Visual Studio 2019

    # ========== 步骤 3: 恢复 NuGet 包 ==========
    - name: Restore NuGet Packages
      run: nuget restore ${{ env.SOLUTION_NAME }}

    # ========== 步骤 4: 构建 x86 版本 ==========
    - name: Build x86 (Win32)
      run: |
        msbuild ${{ env.SOLUTION_NAME }} `
          /p:Configuration=${{ env.BUILD_CONFIGURATION }} `
          /p:Platform=Win32 `
          /p:PlatformToolset=v142 `
          /m `
          /v:minimal

    # ========== 步骤 5: 构建 x64 版本 ==========
    - name: Build x64
      run: |
        msbuild ${{ env.SOLUTION_NAME }} `
          /p:Configuration=${{ env.BUILD_CONFIGURATION }} `
          /p:Platform=x64 `
          /p:PlatformToolset=v142 `
          /m `
          /v:minimal

    # ========== 步骤 6: 收集构建产物 ==========
    - name: Collect Build Artifacts
      shell: pwsh
      run: |
        # 创建打包目录
        New-Item -ItemType Directory -Force -Path ".\VxKex\PackageRoot"
        New-Item -ItemType Directory -Force -Path ".\VxKex\PackageRoot\x86"
        New-Item -ItemType Directory -Force -Path ".\VxKex\PackageRoot\x64"

        # 复制 x86 产物
        Write-Host "Copying x86 binaries..."
        Get-ChildItem -Path ".\VxKex\Release" -Recurse -Include "*.dll","*.exe" |
          Copy-Item -Destination ".\VxKex\PackageRoot\x86" -Force

        # 复制 x64 产物
        Write-Host "Copying x64 binaries..."
        Get-ChildItem -Path ".\VxKex\x64\Release" -Recurse -Include "*.dll","*.exe" |
          Copy-Item -Destination ".\VxKex\PackageRoot\x64" -Force

        # 复制文档和其他资源
        Copy-Item -Path ".\VxKex\00-Documentation\*" -Destination ".\VxKex\PackageRoot" -Recurse -Force
        Copy-Item -Path ".\VxKex\README.md" -Destination ".\VxKex\PackageRoot" -Force

        Write-Host "Build artifacts collected successfully"

    # ========== 步骤 7: 安装 Inno Setup ==========
    - name: Install Inno Setup
      shell: pwsh
      run: |
        $InnoSetupUrl = "https://jrsoftware.org/download.php/is.exe"
        $InnoSetupInstaller = "$env:TEMP\innosetup.exe"

        Write-Host "Downloading Inno Setup..."
        Invoke-WebRequest -Uri $InnoSetupUrl -OutFile $InnoSetupInstaller

        Write-Host "Installing Inno Setup..."
        Start-Process -FilePath $InnoSetupInstaller -ArgumentList "/VERYSILENT","/SUPPRESSMSGBOXES","/NORESTART" -Wait

        # 添加到 PATH
        $InnoSetupPath = "C:\Program Files (x86)\Inno Setup 6"
        echo "$InnoSetupPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    # ========== 步骤 8: 编译安装程序 ==========
    - name: Compile Installer
      shell: pwsh
      run: |
        $IsccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"

        if (-not (Test-Path $IsccPath)) {
          Write-Error "Inno Setup compiler not found at: $IsccPath"
          exit 1
        }

        # 获取版本号
        $Version = if ($env:GITHUB_REF -match 'refs/tags/v(.*)') {
          $matches[1]
        } elseif ($env:GITHUB_EVENT_INPUTS_VERSION) {
          $env:GITHUB_EVENT_INPUTS_VERSION
        } else {
          "1.1.3.1428"
        }

        Write-Host "Building installer for version: $Version"
        Write-Host "Compiling installer using .github/installer/setup.iss..."

        # 使用 /D 参数动态传入版本号
        & $IsccPath ".github\installer\setup.iss" "/DMyAppVersion=$Version"

        if ($LASTEXITCODE -ne 0) {
          Write-Error "Installer compilation failed"
          exit 1
        }

        Write-Host "Installer compiled successfully"

        # 列出生成的安装程序
        Get-ChildItem -Filter "VxKex-*-Setup.exe" | ForEach-Object {
          Write-Host "Generated installer: $($_.Name) ($([math]::Round($_.Length/1MB, 2)) MB)"
        }

    # ========== 步骤 9: 创建便携版压缩包 ==========
    - name: Create Portable Package
      shell: pwsh
      run: |
        $Version = if ($env:GITHUB_REF -match 'refs/tags/v(.*)') {
          $matches[1]
        } elseif ($env:GITHUB_EVENT_INPUTS_VERSION) {
          $env:GITHUB_EVENT_INPUTS_VERSION
        } else {
          "1.1.3.1428"
        }

        # 创建 x86 便携版
        Write-Host "Creating x86 portable package..."
        Compress-Archive -Path ".\VxKex\PackageRoot\x86\*" -DestinationPath "VxKex-$Version-Portable-x86.zip" -Force

        # 创建 x64 便携版
        Write-Host "Creating x64 portable package..."
        Compress-Archive -Path ".\VxKex\PackageRoot\x64\*" -DestinationPath "VxKex-$Version-Portable-x64.zip" -Force

        Write-Host "Portable packages created successfully"

    # ========== 步骤 10: 生成校验和 ==========
    - name: Generate Checksums
      shell: pwsh
      run: |
        Write-Host "Generating SHA256 checksums..."

        Get-ChildItem -Filter "VxKex-*.exe","VxKex-*.zip" | ForEach-Object {
          $Hash = (Get-FileHash -Path $_.FullName -Algorithm SHA256).Hash
          $HashFile = "$($_.Name).sha256"
          "$Hash  $($_.Name)" | Out-File -FilePath $HashFile -Encoding ASCII
          Write-Host "  $($_.Name): $Hash"
        }

    # ========== 步骤 12: 上传构建产物 ==========
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: VxKex-Installers
        path: |
          VxKex-*-Setup.exe
          VxKex-*-Portable-*.zip
          *.sha256
        retention-days: 30

    # ========== 步骤 13: 创建 GitHub Release ==========
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          VxKex-*-Setup.exe
          VxKex-*-Portable-*.zip
          *.sha256
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ========== 步骤 14: 输出构建总结 ==========
    - name: Build Summary
      shell: pwsh
      run: |
        Write-Host ""
        Write-Host "=========================================="
        Write-Host "Build Summary"
        Write-Host "=========================================="
        Write-Host "Configuration: ${{ env.BUILD_CONFIGURATION }}"
        Write-Host "Platforms: Win32 + x64"
        Write-Host ""
        Write-Host "Generated Files:"
        Get-ChildItem -Filter "VxKex-*" | ForEach-Object {
          Write-Host "  - $($_.Name) ($([math]::Round($_.Length/1MB, 2)) MB)"
        }
        Write-Host "=========================================="
