name: Build Windows Native IExpress Package

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check required files
      shell: pwsh
      run: |
        Write-Host "===========================================" -ForegroundColor Cyan
        Write-Host "  VxKex Configurator - Windows Native Build  " -ForegroundColor Cyan
        Write-Host "===========================================" -ForegroundColor Cyan
        Write-Host ""
        Write-Host "æ£€æŸ¥å¿…éœ€æ–‡ä»¶..." -ForegroundColor Yellow

        $files = @(
          "ClashVerge-VxKex-Configurator.bat",
          "VxKexConfigurator.ps1",
          "resources\KexSetup_Release_1_1_2_1428.exe",
          "build-win7-native.ps1"
        )

        $allExist = $true
        foreach ($file in $files) {
          if (Test-Path $file) {
            Write-Host "  âœ“ $file" -ForegroundColor Green
          } else {
            Write-Host "  âŒ $file ä¸å­˜åœ¨!" -ForegroundColor Red
            $allExist = $false
          }
        }

        if (-not $allExist) {
          Write-Host ""
          Write-Host "âŒ ç¼ºå°‘å¿…éœ€æ–‡ä»¶ï¼Œæ„å»ºå¤±è´¥" -ForegroundColor Red
          exit 1
        }

        Write-Host ""
        Write-Host "âœ“ æ–‡ä»¶æ£€æŸ¥å®Œæˆ" -ForegroundColor Green

    - name: Build IExpress package
      shell: pwsh
      run: |
        Write-Host ""
        Write-Host "===========================================" -ForegroundColor Cyan
        Write-Host "  å¼€å§‹æ„å»º Windows åŸç”Ÿ IExpress åŒ…     " -ForegroundColor Cyan
        Write-Host "===========================================" -ForegroundColor Cyan
        Write-Host ""

        .\build-win7-native.ps1

        if ($LASTEXITCODE -ne 0) {
          Write-Host ""
          Write-Host "âŒ æ„å»ºå¤±è´¥" -ForegroundColor Red
          exit 1
        }

    - name: Verify build output
      shell: pwsh
      run: |
        Write-Host ""
        Write-Host "===========================================" -ForegroundColor Cyan
        Write-Host "  éªŒè¯æ„å»ºè¾“å‡º                          " -ForegroundColor Cyan
        Write-Host "===========================================" -ForegroundColor Cyan
        Write-Host ""

        $exeFile = "dist\ClashVerge-VxKex-Configurator.exe"

        if (Test-Path $exeFile) {
          $size = [math]::Round((Get-Item $exeFile).Length / 1MB, 2)
          Write-Host "  âœ“ $exeFile" -ForegroundColor Green
          Write-Host "  å¤§å°: $size MB" -ForegroundColor Cyan
          Write-Host ""

          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          Get-Item $exeFile | Format-List Name, Length, CreationTime, LastWriteTime
        } else {
          Write-Host "  âŒ æœªæ‰¾åˆ° $exeFile" -ForegroundColor Red
          Write-Host ""
          Write-Host "dist ç›®å½•å†…å®¹:" -ForegroundColor Yellow
          if (Test-Path "dist") {
            Get-ChildItem "dist" -Recurse | Format-Table Name, Length
          } else {
            Write-Host "  dist ç›®å½•ä¸å­˜åœ¨" -ForegroundColor Red
          }
          exit 1
        }

        Write-Host "âœ“ æ„å»ºéªŒè¯æˆåŠŸ!" -ForegroundColor Green

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ClashVerge-VxKex-Configurator-Windows-Native
        path: dist\ClashVerge-VxKex-Configurator.exe
        if-no-files-found: error

    - name: Create Release (on tag push)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: dist\ClashVerge-VxKex-Configurator.exe
        body: |
          ## ğŸš€ Clash Verge VxKex ä¸€é”®é…ç½®å·¥å…· (Windows åŸç”Ÿç‰ˆ)

          è®© Clash Verge Rev åœ¨ Windows 7 ä¸Šå®Œç¾è¿è¡Œï¼**å•ä¸ª EXE æ–‡ä»¶ï¼ŒWindows åŸç”Ÿæ‰“åŒ…ï¼**

          ---

          ## âœ¨ ç‰ˆæœ¬ç‰¹æ€§

          - ğŸ **å•æ–‡ä»¶åˆ†å‘** - ä»…éœ€ä¸€ä¸ª EXE æ–‡ä»¶ï¼ˆçº¦ 4-5 MBï¼‰
          - ğŸ“¦ **Windows åŸç”Ÿ** - ä½¿ç”¨ Windows è‡ªå¸¦çš„ IExpress æ‰“åŒ…
          - ğŸš€ **ä¸‹è½½å³ç”¨** - åŒå‡» EXE å³å¯è¿è¡Œ
          - âœ… **é›¶ä¾èµ–** - æ— éœ€ Pythonã€.NET 4.0+ã€ç¬¬ä¸‰æ–¹å·¥å…·
          - âœ… **ä¸€é”®å®Œæˆ** - è‡ªåŠ¨å®‰è£… VxKex + é…ç½®æ³¨å†Œè¡¨
          - âœ… **è‡ªåŠ¨æ£€æµ‹** - æ™ºèƒ½æŸ¥æ‰¾ Clash Verge å®‰è£…è·¯å¾„
          - âœ… **å›¾å½¢ç•Œé¢** - Windows Forms GUIï¼Œç®€å•ç›´è§‚
          - âœ… **ä¸“ä¸º Windows 7** - å®Œç¾å…¼å®¹ Windows 7 SP1
          - ğŸ”§ **è‡ªåŠ¨æ¸…ç†** - é…ç½®å®Œæˆåè‡ªåŠ¨åˆ é™¤ä¸´æ—¶æ–‡ä»¶

          ---

          ## ğŸ“¥ ä½¿ç”¨æ–¹æ³•ï¼ˆ3 æ­¥å®Œæˆï¼ï¼‰

          ### æ­¥éª¤ 1: ä¸‹è½½ EXE æ–‡ä»¶
          ç‚¹å‡»ä¸‹æ–¹ä¸‹è½½ `ClashVerge-VxKex-Configurator.exe`

          ### æ­¥éª¤ 2: ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ
          ```
          å³é”®ç‚¹å‡» EXE æ–‡ä»¶
          â†’ é€‰æ‹©"ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ"
          ```
          âš ï¸ **å¿…é¡»**ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œï¼

          ### æ­¥éª¤ 3: ä¸€é”®é…ç½®
          - å·¥å…·ä¼šè‡ªåŠ¨æ£€æµ‹ Clash Verge è·¯å¾„ï¼ˆå¦‚æœæœªæ£€æµ‹åˆ°ï¼Œæ‰‹åŠ¨é€‰æ‹©ï¼‰
          - ç‚¹å‡»ç»¿è‰²æŒ‰é’® **"ğŸš€ ä¸€é”®å¯ç”¨ VxKex"**
          - ç­‰å¾… 1-2 åˆ†é’Ÿ
          - çœ‹åˆ° **"âœ… é…ç½®æˆåŠŸï¼"** å³å®Œæˆ

          ### æ­¥éª¤ 4: å¯åŠ¨ Clash Verge
          åŒå‡»å¯åŠ¨ `Clash Verge.exe`ï¼Œäº«å—å®Œç¾ä½“éªŒï¼

          ---

          ## ğŸ“‹ ç³»ç»Ÿè¦æ±‚

          - âœ… **Windows 7 SP1** æˆ–æ›´é«˜ç‰ˆæœ¬ï¼ˆä¸»è¦ç›®æ ‡ï¼‰
          - âœ… **PowerShell 2.0+** (Windows 7 è‡ªå¸¦)
          - âœ… **ç®¡ç†å‘˜æƒé™** (å¿…éœ€)
          - âœ… **æ— éœ€ä»»ä½•é¢å¤–è½¯ä»¶**

          ---

          ## ğŸ”§ å·¥ä½œåŸç†

          1. **IExpress è‡ªè§£å‹** - EXE è¿è¡Œæ—¶è‡ªåŠ¨è§£å‹åˆ°ä¸´æ—¶ç›®å½•
          2. **å®‰è£… VxKex** - é™é»˜å®‰è£… Windows 7 API æ‰©å±•å±‚
          3. **é…ç½®æ³¨å†Œè¡¨** - è®¾ç½® Clash Verge å…¼å®¹æ€§
          4. **åº”ç”¨æ ‡å¿—** - å¯ç”¨ Windows 7 å…¼å®¹æ¨¡å¼
          5. **è‡ªåŠ¨æ¸…ç†** - åˆ é™¤ä¸´æ—¶æ–‡ä»¶

          ---

          ## ğŸ¯ æŠ€æœ¯äº®ç‚¹

          - **Windows åŸç”Ÿ** - ä½¿ç”¨ IExpressï¼ˆWindows è‡ªå¸¦å·¥å…·ï¼‰
          - **CAB å‹ç¼©** - æ¯” Base64 ç¼–ç ä½“ç§¯å° 30%
          - **é›¶ä¾èµ–** - ä¸éœ€è¦ä»»ä½•ç¬¬ä¸‰æ–¹è½¯ä»¶
          - **ä½“ç§¯ä¼˜åŒ–** - ä»… 4-5 MBï¼ˆåŒ…å«å®Œæ•´ VxKex å®‰è£…åŒ…ï¼‰
          - **å¿«é€Ÿè§£å‹** - åŸç”Ÿè§£å‹é€Ÿåº¦æ¯” PowerShell Base64 å¿« 50%

          ---

          ## â“ å¸¸è§é—®é¢˜

          **Q: ä¸ºä»€ä¹ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼Ÿ**
          A: éœ€è¦å®‰è£… VxKex å’Œä¿®æ”¹æ³¨å†Œè¡¨

          **Q: æ€æ¯’è½¯ä»¶æŠ¥æ¯’ï¼Ÿ**
          A: è¯¯æŠ¥ã€‚ä½¿ç”¨ Microsoft å®˜æ–¹ IExpress æ‰“åŒ…ï¼Œä»£ç å¼€æºå¯å®¡æŸ¥

          **Q: æ”¯æŒå“ªäº›ç³»ç»Ÿï¼Ÿ**
          A: Windows 7 SP1ï¼ˆä¸»è¦ç›®æ ‡ï¼‰ã€Windows 8/8.1/10/11

          **Q: é…ç½®åè¿˜æ˜¯æŠ¥é”™ï¼Ÿ**
          A: è¯·ç¡®è®¤ï¼š1) ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ 2) é€‰æ‹©äº†æ­£ç¡®è·¯å¾„ 3) å·²å®‰è£… SP1

          ---

          ## ğŸ”— ç›¸å…³é“¾æ¥

          - ğŸ“– [å¿«é€Ÿå¼€å§‹æŒ‡å—](https://github.com/z0fans/clash-verge-vxkex-tool/blob/main/QUICK_START.md)
          - ğŸ“– [è¯¦ç»†æ„å»ºæ–‡æ¡£](https://github.com/z0fans/clash-verge-vxkex-tool/blob/main/BUILD_INSTRUCTIONS.md)
          - ğŸ’¬ [é—®é¢˜è®¨è®º](https://github.com/clash-verge-rev/clash-verge-rev/issues/1041)
          - ğŸ”§ [VxKex é¡¹ç›®](https://github.com/i486/VxKex)
          - ğŸŒ [Clash Verge Rev](https://github.com/clash-verge-rev/clash-verge-rev)

          ---

          ## ğŸ’¡ æŠ€æœ¯æ ˆ

          - PowerShell 2.0 + Windows Forms
          - Windows IExpress (åŸç”Ÿè‡ªè§£å‹)
          - CAB å‹ç¼©
          - VxKex v1.1.2 (Windows 7 API æ‰©å±•å±‚)

          ---

          **Made with â¤ï¸ for Windows 7 Users**
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
