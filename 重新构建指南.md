# 🔨 VxKex Configurator v4.0.1 重新构建指南

## ✅ Bug 已修复

v4.0.0 的路径配置 bug 已在当前版本中修复。现在您需要重新构建安装器。

---

## 📋 前提条件

### 在 Windows 系统上构建

**必需软件：**
1. **NSIS** (Nullsoft Scriptable Install System)

   **安装方式 A: 使用 Chocolatey（推荐）**
   ```batch
   # 安装 Chocolatey（如果尚未安装）
   # 以管理员身份运行 PowerShell:
   Set-ExecutionPolicy Bypass -Scope Process -Force
   [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
   iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

   # 安装 NSIS
   choco install nsis -y
   ```

   **安装方式 B: 手动下载**
   - 访问 https://nsis.sourceforge.io/Download
   - 下载最新版本（推荐 3.08 或更高）
   - 运行安装程序
   - 确保 `makensis.exe` 已添加到系统 PATH

2. **Git**（用于获取源码）
   ```batch
   choco install git -y
   ```

---

## 🚀 构建步骤

### 方法 1: 直接在当前目录构建

如果您已经有了修复后的源码：

```batch
# 1. 进入工具目录
cd tools\vxkex-configurator

# 2. 确认 NSIS 已安装
makensis -VERSION

# 3. 构建安装器
makensis installer.nsi

# 4. 查看输出
dir dist\ClashVerge-VxKex-Configurator.exe
```

**预期输出：**
```
正在处理配置: installer.nsi
...
Output: "dist\ClashVerge-VxKex-Configurator.exe"
安装: 已生成安装程序 (约 4.0 MB)
```

### 方法 2: 从 GitHub 克隆并构建

```batch
# 1. 克隆仓库
git clone https://github.com/z0fans/clash-verge-vxkex-tool.git
cd clash-verge-vxkex-tool

# 2. 构建
makensis installer.nsi

# 3. 输出在 dist 目录
dir dist
```

---

## ✔️ 验证构建结果

### 检查文件信息

```batch
# 查看文件大小（应约 4 MB）
dir dist\ClashVerge-VxKex-Configurator.exe

# 查看文件属性（右键 → 属性 → 详细信息）
# 应显示: 产品版本 4.0.1
```

### 测试运行

```batch
# 1. 右键点击生成的 exe 文件
# 2. 选择"以管理员身份运行"
# 3. 应该看到安装界面，版本号显示 4.0.1
```

---

## 🎯 使用修复后的安装器

### 在 Windows 7 上安装

1. **复制文件**
   - 将 `dist\ClashVerge-VxKex-Configurator.exe` 复制到 Windows 7 系统

2. **运行安装器**
   - 右键 → 以管理员身份运行
   - 点击"安装"

3. **配置工具界面**
   - 应该弹出蓝色的 PowerShell GUI 窗口（不是红色错误窗口！）
   - 点击"浏览..."选择 Clash Verge.exe 路径
   - 点击"🚀 一键启用 VxKex"

4. **等待完成**
   - 进度窗口显示安装过程
   - 看到"✅ 配置完成！"提示框

5. **测试 Clash Verge**
   - 启动 Clash Verge Rev
   - 应该不再出现 `0xc0000005` 错误

---

## 🐛 故障排除

### 问题 1: makensis 命令未找到

**症状：**
```
'makensis' 不是内部或外部命令
```

**解决方案：**
```batch
# 方法 A: 使用完整路径
"C:\Program Files (x86)\NSIS\makensis.exe" installer.nsi

# 方法 B: 添加到 PATH
# 控制面板 → 系统 → 高级系统设置 → 环境变量
# 在 Path 中添加: C:\Program Files (x86)\NSIS
```

### 问题 2: 找不到源文件

**症状：**
```
File: "resources\KexSetup_Release_1_1_2_1428.exe" [compress]
File not found
```

**解决方案：**
```batch
# 确认文件存在
dir resources\KexSetup_Release_1_1_2_1428.exe

# 如果文件不存在，从原始仓库下载
# 或者从 VxKex 官方 GitHub 下载
```

### 问题 3: 构建成功但仍出现红色错误

**可能原因：**
- 使用了旧版本的源码（v4.0.0）
- 需要确保使用修复后的源码

**验证方式：**
```powershell
# 打开 VxKexConfigurator.ps1
# 检查第 8 行是否为:
$script:VxKexInstallerPath = "$PSScriptRoot\KexSetup_Release_1_1_2_1428.exe"

# 注意：不应该有 "resources\" 前缀
```

---

## 📦 分发说明

### 文件清单

构建完成后，您只需要分发一个文件：
```
dist\ClashVerge-VxKex-Configurator.exe  (约 4 MB)
```

### 使用说明（给最终用户）

**简单 3 步：**
1. 下载 `ClashVerge-VxKex-Configurator.exe`
2. 右键 → 以管理员身份运行
3. 按界面提示完成配置

**注意事项：**
- ✅ 仅支持 Windows 7/8/10/11
- ✅ 必须以管理员权限运行
- ✅ 需要联网（VxKex 安装包约 4 MB）
- ✅ 配置完成后即可正常使用 Clash Verge

---

## 🔄 更新现有部署

如果您之前分发了 v4.0.0：

1. **通知用户**
   - v4.0.0 存在 bug，建议升级到 v4.0.1

2. **提供新版本**
   - 重新构建 v4.0.1
   - 替换之前的下载链接

3. **无需卸载旧版本**
   - 新版本可以直接覆盖安装
   - VxKex 本身不需要重新安装（如果之前安装成功）

---

## 📊 版本历史

| 版本 | 发布日期 | 状态 | 说明 |
|------|----------|------|------|
| v4.0.0 | 2025-12-09 | ❌ 废弃 | 路径配置 bug |
| v4.0.1 | 2025-12-10 | ✅ 当前 | 修复路径 bug |

---

## 🆘 获取帮助

如果遇到问题：

1. **查看详细 bug 说明**
   - [BUG_FIX_v4.0.1.md](BUG_FIX_v4.0.1.md)

2. **提交 Issue**
   - https://github.com/z0fans/clash-verge-vxkex-tool/issues

3. **原始问题讨论**
   - https://github.com/clash-verge-rev/clash-verge-rev/issues/1041

---

**构建成功！祝您使用愉快！** 🎉
