name: Build Embedded PowerShell Package

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check required files
      shell: pwsh
      run: |
        Write-Host "æ£€æŸ¥å¿…éœ€æ–‡ä»¶..." -ForegroundColor Yellow

        $files = @(
          "ClashVerge-VxKex-Configurator.bat",
          "VxKexConfigurator.ps1",
          "resources\KexSetup_Release_1_1_2_1428.exe",
          "build-embedded.ps1"
        )

        foreach ($file in $files) {
          if (Test-Path $file) {
            Write-Host "  âœ“ $file" -ForegroundColor Green
          } else {
            Write-Host "  âŒ $file ä¸å­˜åœ¨!" -ForegroundColor Red
            exit 1
          }
        }

        Write-Host "âœ“ æ–‡ä»¶æ£€æŸ¥å®Œæˆ" -ForegroundColor Green

    - name: Build embedded package
      shell: pwsh
      run: |
        Write-Host "å¼€å§‹æ„å»ºå†…åµŒå¼æ‰“åŒ…..." -ForegroundColor Cyan
        .\build-embedded.ps1

    - name: Verify build output
      shell: pwsh
      run: |
        Write-Host "`næ„å»ºè¾“å‡ºéªŒè¯:" -ForegroundColor Cyan

        $ps1File = "dist\ClashVerge-VxKex-Configurator-Embedded.ps1"
        $batFile = "dist\ClashVerge-VxKex-Configurator.bat"

        if (Test-Path $ps1File) {
          $size = [math]::Round((Get-Item $ps1File).Length / 1MB, 2)
          Write-Host "  âœ“ $ps1File ($size MB)" -ForegroundColor Green
        } else {
          Write-Host "  âŒ æœªæ‰¾åˆ° $ps1File" -ForegroundColor Red
          exit 1
        }

        if (Test-Path $batFile) {
          Write-Host "  âœ“ $batFile" -ForegroundColor Green
        } else {
          Write-Host "  âŒ æœªæ‰¾åˆ° $batFile" -ForegroundColor Red
          exit 1
        }

        Write-Host "`nâœ“ æ„å»ºæˆåŠŸ!" -ForegroundColor Green

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ClashVerge-VxKex-Configurator-Embedded
        path: |
          dist\ClashVerge-VxKex-Configurator.bat
          dist\ClashVerge-VxKex-Configurator-Embedded.ps1

    - name: Create Release (on tag push)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist\ClashVerge-VxKex-Configurator.bat
          dist\ClashVerge-VxKex-Configurator-Embedded.ps1
        body: |
          ## Clash Verge VxKex ä¸€é”®é…ç½®å·¥å…· (å†…åµŒå¼ç‰ˆæœ¬)

          ### âœ¨ æ–°ç‰ˆæœ¬ç‰¹æ€§
          - ğŸ **åŒæ–‡ä»¶æ‰“åŒ…** - BAT + PS1ï¼Œæ— éœ€è§£å‹
          - ğŸ“¦ **å†…åµŒèµ„æº** - æ‰€æœ‰æ–‡ä»¶ Base64 ç¼–ç å†…åµŒ
          - ğŸš€ **ä¸‹è½½å³ç”¨** - åŒå‡» BAT æ–‡ä»¶å³å¯è¿è¡Œ
          - âš¡ **é›¶ä¾èµ–** - PowerShell åŸç”Ÿï¼Œæ— éœ€ .NET Framework 4.0+
          - ğŸ’¯ **å®Œç¾å…¼å®¹** - Windows 7 SP1+ åŸç”Ÿæ”¯æŒ
          - ğŸ”§ **è‡ªåŠ¨æ¸…ç†** - é…ç½®å®Œæˆåè‡ªåŠ¨åˆ é™¤ä¸´æ—¶æ–‡ä»¶

          ### ğŸ“¥ ä½¿ç”¨æ–¹æ³•ï¼ˆè¶…çº§ç®€å•ï¼ï¼‰
          1. ä¸‹è½½ä¸¤ä¸ªæ–‡ä»¶ï¼š
             - `ClashVerge-VxKex-Configurator.bat`
             - `ClashVerge-VxKex-Configurator-Embedded.ps1`
          2. å°†ä¸¤ä¸ªæ–‡ä»¶æ”¾åœ¨åŒä¸€ç›®å½•ä¸‹
          3. åŒå‡» `ClashVerge-VxKex-Configurator.bat`
          4. å…è®¸ç®¡ç†å‘˜æƒé™æå‡
          5. è‡ªåŠ¨è§£å‹å¹¶å¯åŠ¨ GUI ç•Œé¢
          6. é€‰æ‹© Clash Verge è·¯å¾„ï¼ˆæˆ–è‡ªåŠ¨æ£€æµ‹ï¼‰
          7. ç‚¹å‡»"ğŸš€ ä¸€é”®å¯ç”¨ VxKex"æŒ‰é’®
          8. âœ… å®Œæˆï¼ç°åœ¨å¯ä»¥å¯åŠ¨ Clash Verge äº†

          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - Windows 7 SP1 æˆ–æ›´é«˜ç‰ˆæœ¬
          - PowerShell 2.0+ (Windows 7+ å†…ç½®)
          - **æ— éœ€ä»»ä½•é¢å¤–è½¯ä»¶**
          - éœ€è¦ç®¡ç†å‘˜æƒé™

          ### ğŸ¯ æŠ€æœ¯è¯´æ˜
          - æ‰€æœ‰æ–‡ä»¶ä½¿ç”¨ Base64 ç¼–ç å†…åµŒåˆ° PS1 è„šæœ¬ä¸­
          - è¿è¡Œæ—¶è‡ªåŠ¨è§£å‹åˆ° %TEMP% ä¸´æ—¶ç›®å½•
          - é…ç½®å®Œæˆåè‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          - æ€»å¤§å°çº¦ 5-6 MBï¼ˆåŒ…å« VxKex å®‰è£…åŒ…ï¼‰

          ### ğŸ”— ç›¸å…³é“¾æ¥
          - [é—®é¢˜è®¨è®º (Issue #1041)](https://github.com/clash-verge-rev/clash-verge-rev/issues/1041)
          - [VxKex é¡¹ç›®](https://github.com/i486/VxKex)
          - [Clash Verge Rev](https://github.com/clash-verge-rev/clash-verge-rev)

          ### ğŸ’¡ æŠ€æœ¯æ ˆ
          - PowerShell + Windows Forms
          - Base64 å†…åµŒèµ„æº
          - 100% åŸç”Ÿ Windows æŠ€æœ¯
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
