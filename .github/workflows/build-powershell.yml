name: Build PowerShell Executable

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install ps2exe
      shell: pwsh
      run: |
        Write-Host "å®‰è£… ps2exe æ¨¡å—..." -ForegroundColor Yellow
        Install-Module -Name ps2exe -Scope CurrentUser -Force
        Import-Module ps2exe
        Write-Host "âœ“ ps2exe å®‰è£…å®Œæˆ" -ForegroundColor Green

    - name: Build with ps2exe
      shell: pwsh
      run: |
        Write-Host "å¼€å§‹æ‰“åŒ… PowerShell è„šæœ¬..." -ForegroundColor Cyan

        # åˆ›å»ºè¾“å‡ºç›®å½•
        New-Item -ItemType Directory -Path "dist" -Force | Out-Null

        # æ‰“åŒ…
        Invoke-PS2EXE `
          -inputFile "VxKexConfigurator.ps1" `
          -outputFile "dist\ClashVerge-VxKex-Configurator.exe" `
          -noConsole `
          -title "Clash Verge VxKex Configurator" `
          -description "Clash Verge VxKex ä¸€é”®é…ç½®å·¥å…· - PowerShell åŸç”Ÿç‰ˆ" `
          -company "Clash Verge Community" `
          -product "VxKex Configurator" `
          -version "1.0.0" `
          -requireAdmin `
          -noError `
          -noOutput `
          -x64

        Write-Host "âœ“ æ‰“åŒ…å®Œæˆ" -ForegroundColor Green

    - name: Copy resources
      shell: pwsh
      run: |
        Write-Host "å¤åˆ¶èµ„æºæ–‡ä»¶..." -ForegroundColor Yellow
        Copy-Item -Path "resources" -Destination "dist\resources" -Recurse -Force
        Write-Host "âœ“ èµ„æºæ–‡ä»¶å¤åˆ¶å®Œæˆ" -ForegroundColor Green

    - name: Check build output
      shell: pwsh
      run: |
        Write-Host "`næ„å»ºè¾“å‡º:" -ForegroundColor Cyan
        Get-ChildItem -Path "dist" -Recurse | ForEach-Object {
          $size = if ($_.PSIsContainer) { "" } else { " ($([math]::Round($_.Length / 1KB, 2)) KB)" }
          Write-Host "  $($_.FullName.Replace($PWD, '.'))$size"
        }

    - name: Create ZIP package
      shell: pwsh
      run: |
        Write-Host "`nåˆ›å»º ZIP å‹ç¼©åŒ…..." -ForegroundColor Yellow
        Compress-Archive -Path "dist\*" -DestinationPath "ClashVerge-VxKex-Configurator-v1.0-PowerShell.zip" -Force
        Write-Host "âœ“ ZIP å‹ç¼©åŒ…åˆ›å»ºå®Œæˆ" -ForegroundColor Green

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ClashVerge-VxKex-Configurator-PowerShell
        path: ClashVerge-VxKex-Configurator-v1.0-PowerShell.zip

    - name: Create Release (on tag push)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: ClashVerge-VxKex-Configurator-v1.0-PowerShell.zip
        body: |
          ## Clash Verge VxKex ä¸€é”®é…ç½®å·¥å…· (PowerShell åŸç”Ÿç‰ˆ)

          ### âœ¨ æ–°ç‰ˆæœ¬ç‰¹æ€§
          - ğŸš€ **PowerShell åŸç”Ÿå®ç°** - æ— éœ€ Python è¿è¡Œæ—¶
          - ğŸ“¦ **ä½“ç§¯æ›´å°** - ä»…åŒ…å« PowerShell è„šæœ¬å’Œèµ„æºæ–‡ä»¶
          - âš¡ **å¯åŠ¨æ›´å¿«** - åŸç”Ÿ Windows æŠ€æœ¯æ ˆ
          - ğŸ›¡ï¸ **æ›´ç¨³å®š** - é¿å…äº† Python DLL å…¼å®¹æ€§é—®é¢˜
          - ğŸ’¯ **å®Œç¾å…¼å®¹** - Windows 7 SP1+ åŸç”Ÿæ”¯æŒ

          ### ğŸ“¥ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½ `ClashVerge-VxKex-Configurator-v1.0-PowerShell.zip`
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. å³é”® `ClashVerge-VxKex-Configurator.exe` â†’ ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ
          4. ç‚¹å‡»"æµè§ˆ..."é€‰æ‹© Clash Verge å¯æ‰§è¡Œæ–‡ä»¶ (æˆ–è‡ªåŠ¨æ£€æµ‹)
          5. ç‚¹å‡»"ğŸš€ ä¸€é”®å¯ç”¨ VxKex"æŒ‰é’®
          6. ç­‰å¾…å®Œæˆï¼ˆçº¦ 1-2 åˆ†é’Ÿï¼‰
          7. âœ… å®Œæˆï¼ç°åœ¨å¯ä»¥å¯åŠ¨ Clash Verge äº†

          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - Windows 7 SP1 æˆ–æ›´é«˜ç‰ˆæœ¬
          - PowerShell 2.0+ (Windows 7+ å†…ç½®)
          - éœ€è¦ç®¡ç†å‘˜æƒé™

          ### ğŸ“¦ æ–‡ä»¶è¯´æ˜
          - `ClashVerge-VxKex-Configurator.exe` - ä¸»ç¨‹åº
          - `resources/KexSetup_Release_1_1_2_1428.exe` - VxKex å®‰è£…åŒ…
          - âš ï¸ å¿…é¡»ä¿æŒ resources æ–‡ä»¶å¤¹ä¸ exe åœ¨åŒä¸€ç›®å½•

          ### ğŸ”— ç›¸å…³é“¾æ¥
          - [é—®é¢˜è®¨è®º (Issue #1041)](https://github.com/clash-verge-rev/clash-verge-rev/issues/1041)
          - [VxKex é¡¹ç›®](https://github.com/i486/VxKex)
          - [Clash Verge Rev](https://github.com/clash-verge-rev/clash-verge-rev)

          ### ğŸ’¡ æŠ€æœ¯æ ˆ
          - PowerShell + Windows Forms
          - ps2exe æ‰“åŒ…å·¥å…·
          - 100% åŸç”Ÿ Windows æŠ€æœ¯
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
